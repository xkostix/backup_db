# Домашнее задание к занятию "`Резервное копирование баз данных`" - `Милованов Константин`
[Домашнее задание](https://github.com/netology-code/sdb-homeworks/blob/main/12-08.md)


### Задание 1. Резервное копирование

Кейс

Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

### Решение

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день. Для данного сценария подходит полное резервное копирование (full backup), выполняемое ежедневно в ночное время (после окончания рабочего дня). Такой подход обеспечивает наличие актуальной копии всех данных на момент завершения предыдущего дня. Восстановление происходит из одного архива, что упрощает процесс и сокращает время восстановления.

Если объём полного бэкапа бобьшой, и полное резервное копирование занимает много времени или ресурсов, можно использовать комбинацию полного и инкрементного/дифференциального резервного копирования. Например, раз в неделю полный бэкап, и в остальные дни дифференциальный.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки. Здесь требуется более частое резервное копирование. Подходящая стратегия — инкрементное или дифференциальное резервное копирование. Если время восстановления (RTO) необоходимо свести к минимальному, то надо использовать дифференциальное резервное копирование. Если же RTO не столь важно, и необходимо экономить место, то подходит инкрементное копирование.

Выполняется полное резервное копирование с определённой периодичностью, например, раз в день. Затем делается инкрементное или дифференциальное копирование - минимум каждый час, или чаще. При восстановлении сначала загружается последний полный бэкап, затем последовательно накатываются инкрементные бэкапы (или один дифференциальный).

1.3. Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных. Да, такой сценарий возможен и реализуется с помощью репликации и отказоустойчивых кластеров с использованием автоматического переключения. Примеры решений: репликация в PostgreSQL с использованием автоматического переключения через менеджеры вроде Patroni или Corosync или pg_auto_failover. В других СУБД — Galera Cluster или Corosync или ProxySQL (MySQL/MariaDB), Always On Availability Groups (MSSQL), Data Guard (Oracle).

Основной сервер (primary/master) синхронно или асинхронно реплицирует данные на резервный (standby/replica). В случае сбоя основного сервера система автоматически переключает трафик на резервный сервер, обеспечивая минимальное время простоя (иногда менее секунды). После восстановления основного сервера он может вернуться в кластер как реплика или быть переведён обратно в роль мастера (в зависимости от политики).

Возможен вариант, когда только одно приложение использует данную БД, и разработчики могут сами управлять подключениями к серверам. Тогда приложение может само контролировать коннект с БД, может подключаться и переключаться от мастера к реплике при необходимости.

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1. * Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

### Решение

2.1. PostgreSQL предоставляет утилиты pg_dump для создания резервной копии и pg_restore для восстановления из копии. Резервное копирование создание дампа:

`pg_dump -h localhost -U username -F c -b -v -f filename.backup dbname`

-F c — custom format (сжатый, можно использовать pg_restore)

-b — включить большие объекты

-v — подробный вывод

-f — файл для сохранения

Восстановление из custom format:

`pg_restore -U username -h localhost -d dbname -v filename.backup`

2.1. Возможно ли автоматизировать этот процесс? Да, возможно. Через скрипт, который запускается через crontab.

Пример скрипта выполнения бекапа бд my_db:

```
#!/bin/bash
BACKUP_DIR="/var/backups/postgres"
DB_NAME="my_db"
USER="postgres"
DATE=$(date +%Y%m%d_%H%M)
pg_dump -U $USER -F c -b -v -f "$BACKUP_DIR/${DB_NAME}_${DATE}.backup" $DB_NAME
# Удаление бэкапов старше 7 дней
find $BACKUP_DIR -name "${DB_NAME}*.backup" -mtime +7 -delete
```

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

3.1. * В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

### Решение

3.1. Пример команды инкрементного резервного копирования. Нужно включить бинарное логирование в конфигурации MySQL. Создается первая, полная копия всей базы данных. Последующие бэкапы сохраняют только те данные, которые изменились с момента последней (полной или инкрементной) копии. Восстановление: Для восстановления необходимо иметь последнюю полную копию и все последующие инкрементные копии в цепочке.

```
# Полный бекап:
bash xtrabackup --user=root --password=пароль --backup --target-dir=/var/backup/full_20260212
```
```
# Инкрементный бэкап:
bash xtrabackup --user=root --password=пароль --backup --target-dir=/var/backup/inc_20260212_2100 --incremental-basedir=/var/backup/full_20260212
```

3.1. * Использование реплики будет давать преимущество в том случае, если при поломке базы необходимо обеспечить моментальное переключение на работающую базу данных.

Но репликация не служит полноценной заменой резервному копированию. Так как при порче данных в мастере этот изъян попадет и в реплику. И тогда понадобится резервная копия.
